<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beyond Cloud — Sephora AI Recommender</title>

  <!-- Google font (optional, looks premium) -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-gradient: linear-gradient(135deg,#fff6f8 0%, #fffaf2 40%, #fff4fb 100%);
      --accent-1: #FF6F91;   /* coral/pink */
      --accent-2: #C977D0;   /* mauve */
      --muted: #7f7f8a;
      --card: #ffffff;
      --glass: rgba(255,255,255,0.6);
      --shadow: 0 8px 30px rgba(18,18,18,0.08);
      --radius: 14px;
      --max-width: 1100px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Montserrat", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg-gradient);
      color:#1c1b20;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
    }

    .container{
      width:100%;
      max-width:var(--max-width);
      display:grid;
      grid-template-columns: 460px 1fr;
      gap:28px;
      align-items:start;
    }

    /* Left column (form) */
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.85));
      border-radius: var(--radius);
      padding:28px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
      min-height:520px;
    }

    .brand {
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:18px;
    }
    .logo {
      width:56px;
      height:56px;
      border-radius:12px;
      background: radial-gradient(circle at 30% 20%, #fff 0%, rgba(255,255,255,0.6) 5%, #FFDCDC 20%, #FFC4E6 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 6px 18px rgba(201,119,208,0.15);
      font-weight:700;
      font-family:"Playfair Display", serif;
      color:#7b2a4a;
    }
    .brand h1{
      font-size:20px;
      margin:0;
      line-height:1;
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size:13px;
      margin-top:2px;
    }

    label.section{
      display:block;
      font-weight:600;
      margin:18px 0 8px;
      color:#3b2a34;
    }

    select, input[type="text"]{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid rgba(28,27,32,0.07);
      background:linear-gradient(180deg,#fff,#fffefc);
      font-size:14px;
      transition:box-shadow .18s ease, transform .12s ease;
    }
    select:focus, input[type="text"]:focus { box-shadow:0 8px 20px rgba(201,119,208,0.08); outline:none; transform:translateY(-1px) }

    .checkbox-grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top:6px;
    }
    .checkbox{
      background:var(--card);
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.04);
      padding:8px 10px;
      display:flex;
      gap:8px;
      align-items:center;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
      font-size:14px;
    }
    .checkbox input{ accent-color:var(--accent-2) }
    .checkbox:hover{ transform:translateY(-4px); box-shadow:0 8px 16px rgba(0,0,0,0.05) }

    /* budget slider */
    .slider-row{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:8px;
    }
    .budget-value{
      min-width:72px;
      text-align:center;
      font-weight:700;
      color:#7b2a4a;
    }
    input[type="range"]{
      -webkit-appearance:none;
      width:100%;
      height:8px;
      border-radius:999px;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      outline:none;
      transition:opacity .2s;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:22px;
      height:22px;
      border-radius:50%;
      background: #fff;
      border:6px solid rgba(255,255,255,0.1);
      box-shadow: 0 6px 16px rgba(120,30,80,0.16);
    }

    .actions{
      display:flex;
      gap:12px;
      margin-top:18px;
      align-items:center;
    }
    .btn{
      padding:12px 16px;
      border-radius:12px;
      border:none;
      font-weight:700;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .btn-primary{
      background:linear-gradient(90deg,var(--accent-1),var(--accent-2));
      color:white;
      box-shadow:0 10px 30px rgba(201,119,208,0.18);
    }
    .btn-outline{
      background:transparent;
      border:1px solid rgba(28,27,32,0.06);
      color:#7b2a4a;
    }
    .btn:hover{ transform:translateY(-4px) }

    .small{
      font-size:13px;
      color:var(--muted);
    }

    /* Right column (results) */
    .results-panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
      border-radius:var(--radius);
      padding:26px;
      min-height:520px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
    }

    .hero {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:12px;
    }
    .hero h2{
      margin:0;
      font-family:"Playfair Display", serif;
      font-size:22px;
      color:#4a2940;
    }
    .hero p{ margin:0; color:var(--muted) }

    .test-users{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      background:linear-gradient(180deg,#fff,#fffefc);
      border:1px solid rgba(0,0,0,0.04);
      cursor:pointer;
      font-weight:600;
      color:#7b2a4a;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .chip:hover{ transform:translateY(-4px); box-shadow:0 8px 18px rgba(0,0,0,0.06) }

    .results{
      margin-top:18px;
      display:grid;
      gap:14px;
      align-content:start;
    }

    .card{
      background:linear-gradient(180deg,#fff,#fffefc);
      border-radius:12px;
      padding:16px;
      display:flex;
      gap:14px;
      align-items:flex-start;
      border:1px solid rgba(0,0,0,0.04);
      transition: transform .14s ease, box-shadow .14s ease;
    }
    .card:hover { transform:translateY(-6px); box-shadow:0 16px 40px rgba(40,30,50,0.06) }
    .thumb{
      width:78px;
      height:78px;
      border-radius:10px;
      background:linear-gradient(135deg,#ffe9f0,#fff0db);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#7b2a4a;
      font-size:12px;
      flex-shrink:0;
      box-shadow:0 8px 18px rgba(0,0,0,0.04);
    }
    .meta{
      flex:1;
    }
    .meta h3{ margin:0; font-size:16px; color:#3b2a34 }
    .meta p{ margin:6px 0 0; color:var(--muted); font-size:14px }
    .price{
      font-weight:800;
      color:#7b2a4a;
      margin-left:12px;
      font-size:15px;
    }

    .reason{
      margin-top:10px;
      padding:10px;
      background: linear-gradient(90deg, rgba(255,245,247,0.6), rgba(255,250,240,0.6));
      border-radius:8px;
      border:1px dashed rgba(201,119,208,0.12);
      font-size:13px;
      color:#5b3a45;
    }

    /* loading spinner */
    .spinner {
      display:inline-block;
      width:42px;
      height:42px;
      border-radius:50%;
      border:4px solid rgba(0,0,0,0.06);
      border-top-color:var(--accent-2);
      animation:spin 1s linear infinite;
      margin-right:10px;
    }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .center{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:24px;
      color:var(--muted);
    }

    /* Responsive */
    @media (max-width:980px){
      .container{ grid-template-columns: 1fr; padding:0 8px }
      .panel, .results-panel{ min-height:auto }
    }

    /* micro animations for input focus */
    input:focus, select:focus, .checkbox:focus { outline:none }
  </style>
</head>
<body>

  <div class="container" role="main" aria-label="Beyond Cloud Recommender UI">
    <!-- Left: Form -->
    <section class="panel" aria-labelledby="form-title">
      <div class="brand" aria-hidden="true">
        <div class="logo">BC</div>
        <div>
          <h1 id="form-title">Beyond Cloud — Recommender</h1>
          <p>Build & test beauty recommendations with cloud-powered AI</p>
        </div>
      </div>

      <form id="recoForm" autocomplete="off" aria-describedby="form-help">
        <label class="section" for="skinType">Skin type</label>
        <select id="skinType" name="skinType" required>
          <option value="">Choose your skin type…</option>
          <option value="normal">Normal</option>
          <option value="oily">Oily</option>
          <option value="dry">Dry</option>
          <option value="combination">Combination</option>
          <option value="sensitive">Sensitive</option>
        </select>

        <label class="section">Concerns</label>
        <div class="checkbox-grid" role="group" aria-label="concerns">
          <label class="checkbox"><input type="checkbox" name="concerns" value="acne"> Acne</label>
          <label class="checkbox"><input type="checkbox" name="concerns" value="anti-aging"> Anti-aging</label>
          <label class="checkbox"><input type="checkbox" name="concerns" value="hydration"> Hydration</label>
          <label class="checkbox"><input type="checkbox" name="concerns" value="coverage"> Coverage</label>
          <label class="checkbox"><input type="checkbox" name="concerns" value="oil_control"> Oil control</label>
          <label class="checkbox"><input type="checkbox" name="concerns" value="pores"> Pores</label>
        </div>

        <label class="section" for="budget">Budget</label>
        <div class="slider-row">
          <input id="budget" name="budget" type="range" min="10" max="200" value="80" step="5" aria-label="Budget slider">
          <div class="budget-value" id="budgetLabel">$80</div>
        </div>

        <label class="section" for="brands">Preferred brands (comma separated)</label>
        <input id="brands" name="brands" type="text" placeholder="e.g. Fenty, Clinique, The Ordinary">

        <div class="actions">
          <button type="submit" class="btn btn-primary" id="getBtn">Get Recommendations</button>
          <button type="button" id="clearBtn" class="btn btn-outline">Reset</button>
        </div>

        <div id="form-help" class="small" style="margin-top:14px">
          Tip: keep an eye on the results panel to the right — we'll show reasons and price estimates.
        </div>
      </form>
    </section>

    <!-- Right: Results -->
    <aside class="results-panel" aria-labelledby="results-title">
      <div class="hero">
        <div>
          <h2 id="results-title">Recommendations</h2>
          <p class="small">Real-time demo — powered by your backend endpoints</p>
          <div class="test-users" style="margin-top:8px">
            <button class="chip" data-user="user_001">Test user: user_001</button>
            <button class="chip" data-user="user_002">Test user: user_002</button>
            <button class="chip" data-user="user_003">Test user: user_003</button>
          </div>
        </div>
        <div style="text-align:right">
          <div class="small">Status</div>
          <div id="statusDot" style="margin-top:6px">Idle</div>
        </div>
      </div>

      <div id="contentArea" style="flex:1; display:flex; flex-direction:column;">
        <div id="placeholder" class="center" aria-live="polite">
          <div style="text-align:center; max-width:480px">
            <div style="font-weight:700; font-size:18px; color:#4a2940">Ready to discover your perfect products</div>
            <div class="small" style="margin-top:8px">Start by selecting skin type, concerns, and budget — then hit <strong>Get Recommendations</strong>.</div>
          </div>
        </div>

        <div id="loading" class="center" style="display:none">
          <div class="spinner" aria-hidden="true"></div>
          <div>Getting recommendations…</div>
        </div>

        <div id="errorBox" style="display:none; margin-top:8px; color:#8a2434; font-weight:600"></div>

        <div id="results" class="results" aria-live="polite"></div>
      </div>
    </aside>
  </div>

  <script>
    // Helper to select
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const form = $('#recoForm');
    const budget = $('#budget');
    const budgetLabel = $('#budgetLabel');
    const loadingEl = $('#loading');
    const resultsEl = $('#results');
    const placeholderEl = $('#placeholder');
    const errorBox = $('#errorBox');
    const getBtn = $('#getBtn');
    const statusDot = $('#statusDot');

    // Update budget label live
    budget.addEventListener('input', () => {
      budgetLabel.textContent = '$' + budget.value;
    });

    // Reset form
    $('#clearBtn').addEventListener('click', () => {
      form.reset();
      budget.value = 80;
      budgetLabel.textContent = '$80';
      resultsEl.innerHTML = '';
      errorBox.style.display = 'none';
      placeholderEl.style.display = '';
      statusDot.textContent = 'Idle';
    });

    async function fetchWithTimeout(resource, options = {}) {
      const { timeout = 15000 } = options;
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const resp = await fetch(resource, { ...options, signal: controller.signal });
        clearTimeout(id);
        return resp;
      } catch (err) {
        clearTimeout(id);
        throw err;
      }
    }

    function showLoading(show){
      placeholderEl.style.display = show ? 'none' : '';
      loadingEl.style.display = show ? 'flex' : 'none';
      errorBox.style.display = 'none';
      if(show){
        statusDot.textContent = 'Loading…';
      } else {
        statusDot.textContent = 'Idle';
      }
    }

    function showError(message){
      loadingEl.style.display = 'none';
      errorBox.style.display = 'block';
      errorBox.textContent = message;
      statusDot.textContent = 'Error';
    }

    function renderResults(items){
      resultsEl.innerHTML = '';
      if(!items || items.length === 0){
        placeholderEl.style.display = '';
        return;
      }
      placeholderEl.style.display = 'none';

      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card';
        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        // create short initials from product name
        const initials = (item.product_name || 'Product').split(' ').slice(0,2).map(w => w[0]).join('').toUpperCase();
        thumb.textContent = initials;

        const meta = document.createElement('div');
        meta.className = 'meta';
        const title = document.createElement('h3');
        title.textContent = item.product_name || item.name || 'Unknown Product';
        const metaInfo = document.createElement('p');
        metaInfo.innerHTML = (item.brand ? '<strong>' + item.brand + '</strong>' : '') + (item.price ? '&nbsp;•&nbsp;$' + item.price.toFixed(2) : '');
        const reason = document.createElement('div');
        reason.className = 'reason';
        reason.textContent = item.reason || 'Recommended based on your inputs.';

        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = item.price ? '$' + item.price.toFixed(2) : '—';

        meta.appendChild(title);
        meta.appendChild(metaInfo);
        meta.appendChild(reason);

        card.appendChild(thumb);
        card.appendChild(meta);
        card.appendChild(price);

        resultsEl.appendChild(card);
      });
    }

    async function getRecommendations(payload){
      showLoading(true);
      resultsEl.innerHTML = '';
      errorBox.style.display = 'none';
      try {
        const resp = await fetchWithTimeout('/recommendations/custom', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          timeout: 20000
        });
        if(!resp.ok){
          let text = await resp.text().catch(()=>null);
          throw new Error(text || ('Server responded ' + resp.status));
        }
        const data = await resp.json();
        // Expecting data to be an array of recommendations
        renderResults(data.recommendations);
        showLoading(false);
        statusDot.textContent = 'Results';
      } catch (err) {
        console.error('Recommendation error', err);
        showError('Could not get recommendations. ' + (err.name === 'AbortError' ? 'Request timed out.' : err.message));
      }
    }

    // handle form submit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const skinType = $('#skinType').value;
      if(!skinType){
        showError('Please choose a skin type.');
        return;
      }
      const concerns = $$('input[name="concerns"]:checked').map(c => c.value);
      const budgetVal = Number($('#budget').value);
      const brandsVal = $('#brands').value.split(',').map(b => b.trim()).filter(Boolean);

      const payload = {
      name: "Custom User",
      age: 25,
      skin_type: skinType,
      concerns: concerns,
      budget_max: budgetVal,
      preferred_brands: brandsVal
      };

      await getRecommendations(payload);
    });

    // test user buttons
    $$('.chip').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const userId = btn.dataset.user;
        if(!userId) return;
        showLoading(true);
        try {
          const resp = await fetchWithTimeout('/recommendations/user/' + encodeURIComponent(userId), { timeout: 15000 });
          if(!resp.ok){
            throw new Error('Server ' + resp.status);
          }
          const data = await resp.json();
          renderResults(data.recommendations);
          loadingEl.style.display = 'none';
          statusDot.textContent = 'User: ' + userId;
        } catch (err) {
          console.error(err);
          showError('Failed to fetch user recommendations: ' + (err.name === 'AbortError' ? 'Timeout' : err.message));
        }
      });
    });

    // Accessibility: Enter/Space on custom chips
    $$('.chip').forEach(ch=>{
      ch.tabIndex = 0;
      ch.addEventListener('keypress', (ev)=>{
        if(ev.key === 'Enter' || ev.key === ' '){
          ch.click();
        }
      });
    });

    // Initial micro-animation for content
    document.addEventListener('DOMContentLoaded', ()=> {
      // subtle fade-in
      document.body.style.opacity = 0;
      document.body.style.transition = 'opacity .45s ease';
      requestAnimationFrame(()=> document.body.style.opacity = 1);
    });

    // Sample data fallback helper (for offline demo) - will only show if backend returns nothing.
    // NOTE: you can remove this if you prefer strict backend-only behavior.
    window.__demoFallback = function(){
      const demo = [
        { product_name: "Luxe Hydrating Serum", brand: "GlowHouse", price: 42.00, reason: "Hydration-focused formula with lightweight hyaluronic blend suited for " + $('#skinType').value },
        { product_name: "Matte Day Foundation", brand: "VelvetSkin", price: 29.50, reason: "Oil-control finish built for combination/oily skin types; budget-friendly pick" }
      ];
      renderResults(demo);
      statusDot.textContent = 'Demo results';
    };

    // If you want to enable test fallback on page load during development:
    // setTimeout(()=> window.__demoFallback(), 700);
  </script>
</body>
</html>
